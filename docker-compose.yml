version: '3.8'

services:
  # Database: PostgreSQL 15 with TimescaleDB
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: videodb
    ports:
      - "5432:5432"
    volumes:
      - ./atlas/src/atlas/schema.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Maia Agent 1: Hunter (Discovery & Ingestion)
  hunter:
    build:
      context: .
      dockerfile: maia/Dockerfile
    command: python -m maia hunter --batch-size 10
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      YOUTUBE_API_KEYS: ${YOUTUBE_API_KEYS}
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}
      VAULT_PATH: ${VAULT_PATH:-/vault}
    restart: unless-stopped

  # Maia Agent 2: Tracker (Velocity Monitoring)
  tracker:
    build:
      context: .
      dockerfile: maia/Dockerfile
    command: python -m maia tracker --batch-size 50
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      YOUTUBE_API_KEYS: ${YOUTUBE_API_KEYS}
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}
      VAULT_PATH: ${VAULT_PATH:-/vault}
    restart: unless-stopped

  # Maia Agent 3: Janitor (Tiered Storage Cleanup)
  janitor:
    build:
      context: .
      dockerfile: maia/Dockerfile
    command: python -m maia janitor --dry-run false
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}
      VAULT_PATH: ${VAULT_PATH:-/vault}
      JANITOR_ENABLED: "true"
      JANITOR_RETENTION_DAYS: "7"
    restart: unless-stopped

  # Maia Agent 4: Archeologist (Historical Video Discovery)
  archeologist:
    build:
      context: .
      dockerfile: maia/Dockerfile
    command: python -m maia archeologist --start-year 2010 --end-year 2024
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      YOUTUBE_API_KEYS: ${YOUTUBE_API_KEYS}
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}
      VAULT_PATH: ${VAULT_PATH:-/vault}
    restart: unless-stopped

  # Maia Agent 5: Scribe (Transcript Extraction)
  scribe:
    build:
      context: .
      dockerfile: maia/Dockerfile
    command: python -m maia scribe --batch-size 10
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}
      VAULT_PATH: ${VAULT_PATH:-/vault}
    restart: unless-stopped

  # Maia Agent 6: Painter (Keyframe Extraction)
  painter:
    build:
      context: .
      dockerfile: maia/Dockerfile
    command: python -m maia painter --batch-size 5
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}
      VAULT_PATH: ${VAULT_PATH:-/vault}
    restart: unless-stopped

  # Legacy: Collector App (for backward compatibility)
  collector:
    build: 
      context: ./collector 
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/videodb
      YOUTUBE_API_KEYS: ${YOUTUBE_API_KEYS}
      PREFECT_API_KEY: ${PREFECT_API_KEY}
      PREFECT_API_URL: ${PREFECT_API_URL}